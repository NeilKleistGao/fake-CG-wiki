## 如何追踪光线
### 什么是光线
这个问题并不是在问物理意义上的光线，而是想探讨光线的数学表达。

为了能够简化光线的表述，我们需要作出以下不完全正确的假设：
+ 光总是沿着直线传播（在重力场的影响下光路会发生偏折）
+ 光线之间不会发生碰撞

在以上的假设下，我们的光线可以被简化为一条射线。这条射线包含有一个起点和一个方向： $r = o + t\vec d, t > 0$ 。
其中 $o$ 点为光线发出的位置； $\vec d$ 为光线传播的方向（一般是单位向量）； $t$ 可以理解为光线传播的“时间”，在某一时刻下光线到达了某个位置。
因此，这个值应该是非负的，因为光线不能反向传播。

```c++
// Ray Tracing in One Weekend中的光线表示
class ray {
    public:
        ray() {}
        ray(const point3& origin, const vec3& direction)
            : orig(origin), dir(direction)
        {}

        point3 origin() const  { return orig; }
        vec3 direction() const { return dir; }

        point3 at(double t) const {
            return orig + t*dir;
        }

    public:
        point3 orig;
        vec3 dir;
};
```

我们实际在做光线追踪时，并不会按照真正意义上的“光路”进行追踪。想象一个场景中有一个大太阳，如果我们要去追逐其发出的每一根光线，
代价是巨大的，并且很多光线可能对我们的结果完全没有贡献（比如背对地球的那些）！所以我们还需要额外再追加一个错误的假设：光路可逆。

众所周知，我们能看到物体是因为光线打到了物体上，并发生了反射和折射，最终进入到我们的眼睛里。而在光线追踪的过程中，我们会让这个过程完全反过来。
我们会假设光线由我们的眼睛出发，不停地打到某些物体，而打到物体的时候我们就“感知”到了某种颜色。虽然这个说法可能有些荒谬，但是我们已经作出了“光总是沿着直线传播”这个假设了，
那么光路在几何的角度确实是可逆的（只是把光线掉转一个方向而已）。

### Whitted光线追踪
Whitted风格的光线追踪是一种递归的光线追踪算法，也是非常简单的一种光追实现。他的基本思想是从摄像机（或者说人眼）发出一系列的光线，如果这些光线打到了场景中的物体，
那么他会根据物体的材质发生反射或者折射。反射或折射出去的光线又再一次被视为一束新的光线，继续重复之前的动作，直到光线打不到任何的物体，或者递归的次数达到了限制（图片来自于GAMES101，下同）：

![Screenshot from 2021-11-27 10-51-27.png](https://i.loli.net/2021/11/27/fybR7nXlNKHoZwA.png)

每次发出的光线需要在场景中找到一个最近的物体（也就是 $t$ 最小的那个），这个物体就是我们所能看到的那个。虽然光线在场景中可能会和大量的物体产生交点，
但这些物体会被第一个相交的物体所挡住，从而不会被我们看到。

![Screenshot from 2021-11-27 10-55-07.png](https://i.loli.net/2021/11/27/PSMoJuajYtT4Q7X.png)

同样的，我们可以作出交点与光源之间的连线。如果这个连线在空间中与其他物体相交，那么我们就会认为这个位置被其他物体所遮挡，导致光线无法直接照射，从而产生阴影；
反之，我们就可以得到实际光线入射的方向（根据连线）和实际光线出射的方向（根据我们从摄像机发出的光线）来计算这个点的光照情况。

递归地执行这些步骤，最终的光线追踪场景看起来就会像这样：

![Screenshot from 2021-11-27 11-01-37.png](https://i.loli.net/2021/11/27/DZdOptURgAoayhs.png)

## 光与物体求交
根据上面的讨论，我们会发现：光线追踪最需要重要的问题之一就是光线何时和物体相交，交点在什么位置。

### 光与隐式表面求交
我们以一个非常简单的隐式表面为例： $(x - a)^2 + (y - b)^2 + (z - c)^2 = r^2$ 。这个隐式表面是以 $(a, b, c)$  为球心， $r$ 为半径的球。
此外我们还有光线的方程 $r = o + t\vec d$ 。我们需要找到他们两的交点。

交点需要满足两个条件：点在光线上，点也要在球上。所以我们不妨将光线方程带入到球中： $(o_x + td_x - a)^2 + (o_y + td_y - b)^2 + (o_z + td_z - c)^2 = r^2$ 。
此时我们只有一个未知数 $t$ ，这是一个关于 $t$ 的一元二次方程，整理后使用求根公式 $\frac{-b \pm \sqrt{b^2 - 4ac}}{2a}$ ，保留最小的正实根即可。如果没有满足要求的解，
我们就认为光线与球不相交。

对于其他的隐式表面，也有类似的做法。如果方程本身没有解析解，也可以使用其他的数值计算算法得出数值解。

### 光与三角形网格求交
在模型中，我们会大量用到三角形网格，因此光线与三角形网格求交至关重要。事实上，三角形的三个点一定在同一平面，所以我们仅仅只需要知道光线与所在平面的交点，
再判断该交点是否在三角形内部即可。

对于一个平面来说，我们需要知道该平面的朝向，这使得我们需要知道它的法线向量。但是朝向同一个方向的平面也有无数个，我们需要找到一个点，让平面经过这个点，从而把平面固定下来。
这就是平面的点法方程（点-法线方程）： $(p - o)\vec n = 0$ ，其中 $o$ 是平面所经过的固定点，而 $\vec n$ 是平面的法线。此时求解光线与平面的交点就变为了一个隐式表明求交的过程。

这样做麻烦的一点是：我们需要先求出光线与平面的交点，才能判断其是否在三角形内。这一共要分两步，但我们还是希望可以在一步内完成这个计算。
由重心坐标公式，我们可以将点表示为三个顶点的线性组合，并且如果它在三角形内，系数应该满足相应的条件。

我们直接将该式子带入到光线方程中： $o + t\vec d = \alpha v_1 + \beta v_2 + \gamma v_3$ ，此时我们有三个未知数（需要将 $\gamma$ 写作 $1 - \alpha - \beta$ ）和三个方程。
将其写为矩阵形式可以得到：

$$
\begin{bmatrix}
    d_x & (v_{3x} - v_{1x}) & (v_{3x} - v_{2x}) \\
    d_y & (v_{3y} - v_{1y}) & (v_{3y} - v_{2y})  \\
    d_z & (v_{3z} - v_{1z}) & (v_{3z} - v_{2z}) 
\end{bmatrix}
\begin{bmatrix}
    t \\
    \alpha \\
    \beta
\end{bmatrix}
=
\begin{bmatrix}
    v_{3x} - o_x \\
    v_{3y} - o_y  \\
    v_{3z} - o_z 
\end{bmatrix}
$$

解出该方程并判断解是否合法，即可得到光线与三角形的交点。这就是**Möller-Trumbore算法**。

## 参考资料
+ [GAMES101-现代计算机图形学入门-闫令琪](https://www.bilibili.com/video/BV1X7411F744?p=13)
+ [Ray Tracing in One Weekend](https://raytracing.github.io/books/RayTracingInOneWeekend.html)
+ [光-维基百科](https://zh.wikipedia.org/wiki/%E5%85%89)